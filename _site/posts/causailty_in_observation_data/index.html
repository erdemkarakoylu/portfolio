<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.319">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Erdem Karakoylu">
<meta name="dcterms.date" content="2022-08-08">

<title>A Blog + Portfolio - Evaluating causality in observational data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">A Blog + Portfolio</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../projects.html" rel="" target="">
 <span class="menu-text">Projects and posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resume.html" rel="" target="">
 <span class="menu-text">My CV</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About Me</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Evaluating causality in observational data</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">causality</div>
                <div class="quarto-category">propensity score</div>
                <div class="quarto-category">R</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Erdem Karakoylu </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 8, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="preamble-causality-in-observational-data" class="level2">
<h2 class="anchored" data-anchor-id="preamble-causality-in-observational-data">Preamble: Causality in observational data</h2>
<p>This post illustrates some ways of inferring causality in observational data. Establishing causality of a treatment or similar intervention is more easily done under conditions where all possible factors that may affect the outcome can be controlled for; what is referred to as Randomized Control Trials (RCT.)</p>
<p>Establishing causal link in observational studies can be quite challenging. This is because there can be many potential confounders, not all of which might be identified. By confounder I mean “a variable whose presence affects the variables being studied so that the results do not reflect the actual relationship” (<a href="https://pubmed.ncbi.nlm.nih.gov/24834204/"><em>Pourhoseingholi et al.&nbsp;2012</em></a><em>.</em>)</p>
<p>This project illustrates the use of matching and propensity score to establish a causal link beween treatment and outcome in an observational study by <em>Lalonde (1986)</em>; a pdf of the paper is available <a href="https://www.researchgate.net/publication/4900843_Evaluating_the_Econometric_Evaluations_of_Training_Programs_with_Experiment_Data">here</a>. The goal of the study was to evaluate the impact of an employment and training program. The data I use here is a subset of the data generated by this study; it includes 614 observations in total with 10 variables. This data is included in <em>Matching; one of the</em> libraries I use for this project. The data is loaded as follows.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(lalonde)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The loaded data includes a number of covariates, an outcome variable and a treatment flag indicating whether the subject was part of the control or the treatment group. These variables are named and summarized in the table below.</p>
<table class="table">
<thead>
<tr class="header">
<th>Variable</th>
<th>Summary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>age<sup>1</sup></td>
<td>in floating point years</td>
</tr>
<tr class="even">
<td>race<sup>1</sup></td>
<td>One of Black, Hispanic, White</td>
</tr>
<tr class="odd">
<td>educ<sup>1</sup></td>
<td>years of schooling</td>
</tr>
<tr class="even">
<td>married<sup>1</sup></td>
<td>Boolean for marital status</td>
</tr>
<tr class="odd">
<td>nodegree<sup>1</sup></td>
<td>Boolean for high school diploma</td>
</tr>
<tr class="even">
<td>re74<sup>1</sup></td>
<td>real earnings in 1974</td>
</tr>
<tr class="odd">
<td>re75<sup>1</sup></td>
<td>real earnings in 1975</td>
</tr>
<tr class="even">
<td>re78<sup>2</sup></td>
<td>real earnings in 1978</td>
</tr>
<tr class="odd">
<td>treat<sup>3</sup></td>
<td>Boolean for treatment status</td>
</tr>
</tbody>
</table>
<p>For convenience, I one-hot encode the race variable, and cast it in its new format along with the rest of the data in a new table that follows. Note that in the present subset of this data, only black and white subjects were available. I therefore do not include hispanic as a covariate in the analysis that follows. For convenience, I also change the outcome variable, <span class="math inline">\(re78\)</span> to the more meaningful name <span class="math inline">\(outcome\)</span>.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>hispan<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(lalonde<span class="sc">$</span>race<span class="sc">==</span><span class="st">'hispan'</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>black<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(lalonde<span class="sc">$</span>race<span class="sc">==</span><span class="st">'black'</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>white<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(lalonde<span class="sc">$</span>race<span class="sc">==</span><span class="st">'white'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>age<span class="ot">&lt;-</span>lalonde<span class="sc">$</span>age</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>educ<span class="ot">&lt;-</span>lalonde<span class="sc">$</span>educ</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>married<span class="ot">&lt;-</span>lalonde<span class="sc">$</span>married</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>nodegree<span class="ot">&lt;-</span>lalonde<span class="sc">$</span>nodegree</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>re74<span class="ot">&lt;-</span>lalonde<span class="sc">$</span>re74</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>re75<span class="ot">&lt;-</span>lalonde<span class="sc">$</span>re75</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>treat<span class="ot">&lt;-</span>lalonde<span class="sc">$</span>treat</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>outcome<span class="ot">&lt;-</span>lalonde<span class="sc">$</span>re78</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>mydata<span class="ot">&lt;-</span><span class="fu">cbind</span>(age, educ, married, nodegree, black, white, hispan, </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>              re74, re75, treat, outcome)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>mydata<span class="ot">&lt;-</span><span class="fu">data.frame</span>(mydata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>All covariates are expected to be confounders. Thus it is important to evaluate whether the data is balanced between treatment and control groups; i.e.&nbsp;whether the covariates are similarly distributed between the two groups. If they are then the analysis can proceed. Otherwise, the data needs to be balanced. One way to balance data is to use <em>matching</em>; another will use something called propensity score. Next, I will illustrate both appraoches.</p>
</section>
<section id="matching" class="level2">
<h2 class="anchored" data-anchor-id="matching">Matching</h2>
<section id="to-match-or-not-to-match" class="level3">
<h3 class="anchored" data-anchor-id="to-match-or-not-to-match">To match or not to match?</h3>
<p>A first step is whether the data on hand is appropriate for causal inferrence, in particular, whether it should be balanced. A commonly used metric to figure out whether balancing the data is required is Standardized Mean Difference (<span class="math inline">\(SMD\)</span>), defined as the difference between group means divided by the pooled standard deviation, like so:</p>
<p><span class="math display">\[
SMD = \frac{\bar{X}_{treatment}-\bar{X}_{control}}
{\sqrt{\frac{s^2_{treatment}+s^2_{control}}{2}}}
\]</span> An easy way to examine covariates is to cast them into what is know as a <code>Table 1</code>, after a common pattern in the biomedical research litterature to feature patient attributes in the first table of published papers. The <em>R</em> library tableone is commonly used for this purpose, with the added benefit that the SMD is given out of the box as shown below. Here the data is stratified by treatment group and only the covariates are tabulated.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tableone)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a vector of the variable names to be used</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>xvars <span class="ot">&lt;-</span><span class="fu">c</span>(<span class="st">"hispan"</span>, <span class="st">"black"</span>, <span class="st">"white"</span>, <span class="st">"age"</span>, <span class="st">"educ"</span>, <span class="st">"married"</span>, <span class="st">"nodegree"</span>, </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>              <span class="st">"re74"</span>, <span class="st">"re75"</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># load to a table 1</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>table1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">vars=</span>xvars, <span class="at">strata=</span><span class="st">"treat"</span>, <span class="at">data=</span>mydata, <span class="at">test=</span><span class="cn">FALSE</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># show table, in particular display SMDs corresponding to each covariate. </span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(table1, <span class="at">smd=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                      Stratified by treat
                       0                 1                 SMD   
  n                        429               185                 
  hispan (mean (SD))      0.14 (0.35)       0.06 (0.24)     0.277
  black (mean (SD))       0.20 (0.40)       0.84 (0.36)     1.668
  white (mean (SD))       0.66 (0.48)       0.10 (0.30)     1.406
  age (mean (SD))        28.03 (10.79)     25.82 (7.16)     0.242
  educ (mean (SD))       10.24 (2.86)      10.35 (2.01)     0.045
  married (mean (SD))     0.51 (0.50)       0.19 (0.39)     0.719
  nodegree (mean (SD))    0.60 (0.49)       0.71 (0.46)     0.235
  re74 (mean (SD))     5619.24 (6788.75) 2095.57 (4886.62)  0.596
  re75 (mean (SD))     2466.48 (3292.00) 1532.06 (3219.25)  0.287</code></pre>
</div>
</div>
<p>Note that an alternative would be to conduct two-tailed t-tests to assess difference between group (treated and control) means for each covariate, and evaluate their corresponding p-value. This is however not without drawbacks; most importantly the resulting p-value will depend on the sample size. I therefore use <span class="math inline">\(SMD\)</span> in this post.</p>
<p>By convention, an <span class="math inline">\(SMD\)</span> greater than 0.1 suggest an imbalance with respect to the corresponding covariate. Here <span class="math inline">\(SMD&gt;0.1\)</span> for all covariates except <em>education</em>. Treated subjects need each to be match via greedy matching to as close as possible a control subject. Matching between subjects is done on the basis of a distance metric indicating how separated they are in the covariate space. The specific metric used in this case is the <strong>Mahalanobis distance</strong>, which is a kind of standardized difference, computed as follows: <span class="math display">\[d = \sqrt{(X_i-X_j)^T C^{-1} (X_i-X_j) }\]</span> where <span class="math inline">\(X\)</span> is a covariate, <span class="math inline">\(i\)</span> and <span class="math inline">\(j\)</span> are treated and control subjects, and <span class="math inline">\(C\)</span> is the covariance matrix</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matching)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Below M=1 refers to pairwise matching. Even so if "ties" is left as TRUE (default)</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co"># multiple subjects within the tolerance threshold will all be matched. </span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># In this case, e.g. not setting ties=TRUE yields 207 pairs, even though there are only # 185 treated subjects.</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>greedymatch<span class="ot">&lt;-</span><span class="fu">Match</span>(<span class="at">Tr=</span>treat, <span class="at">M=</span><span class="dv">1</span>, <span class="at">X=</span>mydata[xvars], <span class="at">ties=</span><span class="cn">FALSE</span>) </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>matched<span class="ot">&lt;-</span>mydata[<span class="fu">unlist</span>(greedymatch[<span class="fu">c</span>(<span class="st">"index.treated"</span>, <span class="st">"index.control"</span>)]), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>I create another <em>Table 1</em> with the matched data check the SMDs.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>matchedtab1<span class="ot">&lt;-</span><span class="fu">CreateTableOne</span>(<span class="at">vars=</span>xvars, <span class="at">strata=</span><span class="st">"treat"</span>, <span class="at">data=</span>matched, <span class="at">test=</span><span class="cn">FALSE</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(matchedtab1, <span class="at">smd=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>                      Stratified by treat
                       0                 1                 SMD   
  n                        185               185                 
  hispan (mean (SD))      0.06 (0.24)       0.06 (0.24)    &lt;0.001
  black (mean (SD))       0.84 (0.37)       0.84 (0.36)     0.015
  white (mean (SD))       0.10 (0.30)       0.10 (0.30)     0.018
  age (mean (SD))        25.36 (8.29)      25.82 (7.16)     0.059
  educ (mean (SD))       10.45 (1.96)      10.35 (2.01)     0.054
  married (mean (SD))     0.19 (0.39)       0.19 (0.39)    &lt;0.001
  nodegree (mean (SD))    0.71 (0.46)       0.71 (0.46)    &lt;0.001
  re74 (mean (SD))     2159.92 (4240.18) 2095.57 (4886.62)  0.014
  re75 (mean (SD))     1119.08 (2442.29) 1532.06 (3219.25)  0.145</code></pre>
</div>
</div>
<p>Greedy pairwise matching yields, as expected, a reduced data set with 185 subjects in each group. This time all but the variable <span class="math inline">\(re75\)</span> have corresponding <span class="math inline">\(SMD&lt;0.1\)</span>. This is not entirely satisfactory and I will attempt to balance the data set using propensity scores next. Before doing so, however, I do a quick outcome analysis and compare the means of the two groups.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome Analysis:</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Carry a paired t-test on the matched data to get a causal risk difference</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>treated_outcome<span class="ot">&lt;-</span>matched<span class="sc">$</span>outcome[matched<span class="sc">$</span>treat<span class="sc">==</span><span class="dv">1</span>]</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>control_outcome<span class="ot">&lt;-</span>matched<span class="sc">$</span>outcome[matched<span class="sc">$</span>treat<span class="sc">==</span><span class="dv">0</span>]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">mean</span>(treated_outcome) <span class="sc">-</span> <span class="fu">mean</span>(control_outcome), <span class="at">digits=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 89.28</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">#pairwise difference</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>diff_outcome <span class="ot">=</span> treated_outcome <span class="sc">-</span> control_outcome</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#paired t-test</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="fu">t.test</span>(diff_outcome)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
    One Sample t-test

data:  diff_outcome
t = 0.13174, df = 184, p-value = 0.8953
alternative hypothesis: true mean is not equal to 0
95 percent confidence interval:
 -1247.709  1426.265
sample estimates:
mean of x 
 89.27819 </code></pre>
</div>
</div>
<p>A p-value of .92 suggests the difference is not significant.</p>
</section>
</section>
<section id="propensity-score-matching" class="level2">
<h2 class="anchored" data-anchor-id="propensity-score-matching">Propensity score matching</h2>
<p>A propensity score denoted here <span class="math inline">\(\pi\)</span> is defined as the probability that a subject <span class="math inline">\(i\)</span> received treatment conditioned on the covariates <span class="math inline">\(X\)</span>. I.e. <span class="math inline">\(\pi_i = P(T=1|X_i)\)</span>. A <span class="math inline">\(\pi_i=0.4\)</span> means there’s a 40% chance the corresponding subject will receive treatment. Covariates can increase or decrease the probability of receiving treatment. For example, if <span class="math inline">\(X\)</span>, simplistically the only covariate, is a boolean variable for smoking and smokers are more likely to get a particular treatment then <span class="math inline">\(P(T=1|X=1) \gt P(T=1|X=0)\)</span>.</p>
<p>Interestingly, two subjects may have the same propensity score in spite of having different covariate values <span class="math inline">\(X\)</span>, meaning they are equally likely to receive treatment. Thus reducing the data to a subset of subjects with the same <span class="math inline">\(\pi\)</span> should balance the treated and control groups. In doing so a crucial assumption in causality, <em>ignorability</em> i.e.&nbsp;how a subject ended in one or the other group can be safely ignored. In a randomized trial, the propensity score is known. In an observational study <span class="math inline">\(\pi\)</span> is unknown. However because both <span class="math inline">\(X\)</span> and <span class="math inline">\(T\)</span> are collected, <span class="math inline">\(\pi\)</span> can be estimated. For this I will use a logistic regression model where the covariates are the input and the output is the probability of a subject having received treatment.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>psmodel <span class="ot">&lt;-</span> <span class="fu">glm</span>(treat<span class="sc">~</span>hispan<span class="sc">+</span>white<span class="sc">+</span>black<span class="sc">+</span>age<span class="sc">+</span>educ<span class="sc">+</span>married<span class="sc">+</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>                 nodegree<span class="sc">+</span>re74<span class="sc">+</span>re75,<span class="at">family=</span><span class="fu">binomial</span>(), <span class="at">data=</span>mydata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The model fit is summarized below.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># show fit summary</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(psmodel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = treat ~ hispan + white + black + age + educ + married + 
    nodegree + re74 + re75, family = binomial(), data = mydata)

Coefficients: (1 not defined because of singularities)
              Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept) -1.663e+00  9.709e-01  -1.713  0.08668 .  
hispan      -2.082e+00  3.672e-01  -5.669 1.44e-08 ***
white       -3.065e+00  2.865e-01 -10.699  &lt; 2e-16 ***
black               NA         NA      NA       NA    
age          1.578e-02  1.358e-02   1.162  0.24521    
educ         1.613e-01  6.513e-02   2.477  0.01325 *  
married     -8.321e-01  2.903e-01  -2.866  0.00415 ** 
nodegree     7.073e-01  3.377e-01   2.095  0.03620 *  
re74        -7.178e-05  2.875e-05  -2.497  0.01253 *  
re75         5.345e-05  4.635e-05   1.153  0.24884    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 751.49  on 613  degrees of freedom
Residual deviance: 487.84  on 605  degrees of freedom
AIC: 505.84

Number of Fisher Scoring iterations: 5</code></pre>
</div>
</div>
<p>Next I extract the propensity scores from the model object.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create propensity score</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>pscore<span class="ot">&lt;-</span>psmodel<span class="sc">$</span>fitted.values</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Finally, I use the MatchIt package to match subjects based on their propensity scores. Note that I set a seed for reproducibility, since matching randomizes data as a first step.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">42</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>m.out<span class="ot">&lt;-</span><span class="fu">matchit</span>(treat<span class="sc">~</span>hispan<span class="sc">+</span>white<span class="sc">+</span>black<span class="sc">+</span>age<span class="sc">+</span>educ<span class="sc">+</span>married<span class="sc">+</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>                 nodegree<span class="sc">+</span>re74<span class="sc">+</span>re75, <span class="at">data=</span>mydata, <span class="at">method=</span><span class="st">"nearest"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The matching results are summarized below.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># summarize the matching outcome</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(m.out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
matchit(formula = treat ~ hispan + white + black + age + educ + 
    married + nodegree + re74 + re75, data = mydata, method = "nearest")

Summary of Balance for All Data:
         Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance        0.5774        0.1822          1.7941     0.9211    0.3774
hispan          0.0595        0.1422         -0.3498          .    0.0827
white           0.0973        0.6550         -1.8819          .    0.5577
black           0.8432        0.2028          1.7615          .    0.6404
age            25.8162       28.0303         -0.3094     0.4400    0.0813
educ           10.3459       10.2354          0.0550     0.4959    0.0347
married         0.1892        0.5128         -0.8263          .    0.3236
nodegree        0.7081        0.5967          0.2450          .    0.1114
re74         2095.5737     5619.2365         -0.7211     0.5181    0.2248
re75         1532.0553     2466.4844         -0.2903     0.9563    0.1342
         eCDF Max
distance   0.6444
hispan     0.0827
white      0.5577
black      0.6404
age        0.1577
educ       0.1114
married    0.3236
nodegree   0.1114
re74       0.4470
re75       0.2876

Summary of Balance for Matched Data:
         Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean
distance        0.5774        0.3629          0.9739     0.7566    0.1321
hispan          0.0595        0.2162         -0.6629          .    0.1568
white           0.0973        0.3135         -0.7296          .    0.2162
black           0.8432        0.4703          1.0259          .    0.3730
age            25.8162       25.3027          0.0718     0.4568    0.0847
educ           10.3459       10.6054         -0.1290     0.5721    0.0239
married         0.1892        0.2108         -0.0552          .    0.0216
nodegree        0.7081        0.6378          0.1546          .    0.0703
re74         2095.5737     2342.1076         -0.0505     1.3289    0.0469
re75         1532.0553     1614.7451         -0.0257     1.4956    0.0452
         eCDF Max Std. Pair Dist.
distance   0.4216          0.9740
hispan     0.1568          1.0743
white      0.2162          0.8390
black      0.3730          1.0259
age        0.2541          1.3938
educ       0.0757          1.2474
married    0.0216          0.8281
nodegree   0.0703          1.0106
re74       0.2757          0.7965
re75       0.2054          0.7381

Sample Sizes:
          Control Treated
All           429     185
Matched       185     185
Unmatched     244       0
Discarded       0       0</code></pre>
</div>
</div>
<p>The figures below also illustrate the matching outcome.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># propensity score plots</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m.out, <span class="at">type=</span><span class="st">"hist"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The jitter plot below shows the overlap between matched groups.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(m.out, <span class="at">type=</span><span class="st">"jitter"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="index_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>To identify the units, use first mouse button; to stop, use second.</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>