---
title: "Evaluating causality in observational data"
author: "Erdem Karakoylu"
date: "2022-08-08"
categories: [causality, propensity score, R]
image: "effect-1.webp"
---

## Preamble: Causality in observational data
This post illustrates some ways of inferring causality in observational data. Establishing causality of a treatment or similar intervention is more easily done under conditions where all possible factors that may affect the outcome can be controlled for; what is referred to as Randomized Control Trials (RCT.)

Establishing causal link in observational studies can be quite challenging. This is because there can be many potential confounders, not all of which might be identified. By confounder I mean "a variable whose presence affects the variables being studied so that the results do not reflect the actual relationship" ([*Pourhoseingholi et al. 2012*](https://pubmed.ncbi.nlm.nih.gov/24834204/)*.*)

This project illustrates the use of matching and propensity score to establish a causal link beween treatment and outcome in an observational study by *Lalonde (1986)*; a pdf of the paper is available [here](https://www.researchgate.net/publication/4900843_Evaluating_the_Econometric_Evaluations_of_Training_Programs_with_Experiment_Data). The goal of the study was to evaluate the impact of an employment and training program. The data I use here is a subset of the data generated by this study; it includes 614 observations in total with 10 variables. This data is included in *Matching; one of the* libraries I use for this project. The data is loaded as follows.

```{r, warning=FALSE, message=FALSE}
library(Matching)
data(lalonde)
```

The loaded data includes a number of covariates, an outcome variable and a treatment flag indicating whether the subject was part of the control or the treatment group. These variables are named and summarized in the table below.

| Variable    | Summary                         |
|-------------|---------------------------------|
| age^1^      | in floating point years         |
| race^1^     | One of Black, Hispanic, White   |
| educ^1^     | years of schooling              |
| married^1^  | Boolean for marital status      |
| nodegree^1^ | Boolean for high school diploma |
| re74^1^     | real earnings in 1974           |
| re75^1^     | real earnings in 1975           |
| re78^2^     | real earnings in 1978           |
| treat^3^    | Boolean for treatment status    |

For convenience, I one-hot encode the race variable, and cast it in its new format along with the rest of the data in a new table that follows. Note that in the present subset of this data, only black and white subjects were available. I therefore do not include hispanic as a covariate in the analysis that follows. For convenience, I also change the outcome variable, $re78$ to the more meaningful name $outcome$.
```{r}
#hispan<-as.numeric(lalonde$race=='hispan.')
black<-as.numeric(lalonde$race=='black')
white<-as.numeric(lalonde$race=='white')
age<-lalonde$age
educ<-lalonde$educ
married<-lalonde$married
nodegree<-lalonde$nodegree
re74<-lalonde$re74
re75<-lalonde$re75
treat<-lalonde$treat
outcome<-lalonde$re78
mydata<-cbind(age, black, white, educ, nodegree, married, 
              re74, re75, treat, outcome)
mydata<-data.frame(mydata)
```
All covariates are expected to be confounders. Thus it is important to evaluate whether the data is balanced between treatment and control groups; i.e. whether the covariates are similarly distributed between the two groups. If they are then the analysis can proceed. Otherwise, the data needs to be balanced. One way to balance data is to use *matching*; another will use something called propensity score. Next, I will illustrate both appraoches.

## Matching
### To match or not to match?

A first step is whether the data on hand is appropriate for causal inferrence, in particular, whether it should be balanced. A commonly used metric to figure out whether balancing the data is required is Standardized Mean Difference ($SMD$), defined as the difference between group means divided by the pooled standard deviation, like so:

$$
SMD = \frac{\bar{X}_{treatment}-\bar{X}_{control}}
{\sqrt{\frac{s^2_{treatment}+s^2_{control}}{2}}}
$$
An easy way to examine covariates is to cast them into what is know as a `Table 1`, after a common pattern in the biomedical research litterature to feature patient attributes in the first table of published papers. The *R* library tableone is commonly used for this purpose, with the added benefit that the SMD is given out of the box as shown below. Here the data is stratified by treatment group and only the covariates are tabulated.
```{r}
library(tableone)

# Make a vector of the variable names to be used
xvars <- c("age", "black", "white", "educ", "nodegree", "married", 
              "re74", "re75", "treat", "outcome")
# load to a table 1
table1 <- CreateTableOne(vars=xvars, strata="treat", data=mydata, test=FALSE)

# show table, in particular display SMDs corresponding to each covariate. 
print(table1, smd=TRUE)
```
Note that an alternative would be to conduct two-tailed t-tests to assess difference between group means for each covariate, and evaluate their corresponding p-value. This is however not without drawbacks; most importantly the resulting p-value will depend on the sample size.





